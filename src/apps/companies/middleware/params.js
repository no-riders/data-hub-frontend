const { getFormattedAddress } = require('../../../lib/address')
const { getDitCompany, getCHCompany } = require('../repos')
const { isValidGuid } = require('../../../lib/controller-utils')

// TODO: Use transformer to return correct address object and handle display
// in view layer
function getHeadingAddress (company) {
  // If this is a CDMS company
  const cdmsTradingAddress = getFormattedAddress(company, 'trading')
  if (cdmsTradingAddress) {
    return cdmsTradingAddress
  }

  if (company.companies_house_data && company.companies_house_data !== null) {
    return getFormattedAddress(company.companies_house_data, 'registered')
  }

  return getFormattedAddress(company, 'registered')
}

async function getCompany (req, res, next, companyId) {
  if (!isValidGuid(companyId)) {
    return next()
  }

  try {
    const company = await getDitCompany(req.session.token, companyId)

    company.address = getHeadingAddress(company)

    res.locals.company = company

    next()
  } catch (error) {
    next(error)
  }
}

async function getCompaniesHouseRecord (req, res, next, companyNumber) {
  try {
    res.locals.companiesHouseRecord = await getCHCompany(req.session.token, companyNumber)
    next()
  } catch (error) {
    next(error)
  }
}

module.exports = {
  getCompany,
  getCompaniesHouseRecord,
}
